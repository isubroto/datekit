name: Release & Publish

on:
  push:
    branches:
      - main

jobs:
  release:
    runs-on: ubuntu-latest
    concurrency: release
    permissions:
      contents: write
      packages: write
      issues: write
      pull-requests: write
      id-token: write

    steps:
      - name: ðŸ“¥ Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ðŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "23"
          registry-url: "https://registry.npmjs.org"

      - name: ðŸ“š Install dependencies
        run: npm ci

      - name: ðŸ§ª Run tests
        run: npm test

      - name: ðŸ”¨ Build
        run: npm run build

      - name: ðŸ“Š Verify build output
        run: |
          echo "ðŸ“¦ Build output:"
          ls -la dist/
          echo ""
          echo "ðŸ“‹ Package contents preview:"
          npm pack --dry-run

      - name: ðŸ”§ Install semantic-release
        run: |
          npm install --no-save \
            semantic-release \
            @semantic-release/git \
            @semantic-release/npm \
            @semantic-release/github \
            @semantic-release/commit-analyzer \
            @semantic-release/release-notes-generator \
            @semantic-release/changelog \
            @semantic-release/exec

      - name: ðŸš€ Run semantic-release
        id: release
        run: npx semantic-release --branches main
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          NPM_TOKEN: ${{ secrets.NPM_TOKEN }}
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}

      - name: ðŸ·ï¸ Get latest tag
        id: latest_tag
        run: |
          if git describe --tags --abbrev=0 > /dev/null 2>&1; then
            LATEST_TAG=$(git describe --tags --abbrev=0)
          else
            LATEST_TAG="v0.0.0"
          fi
          echo "Latest tag: $LATEST_TAG"
          echo "LATEST_TAG=$LATEST_TAG" >> $GITHUB_OUTPUT

      - name: ï¿½ Update GitHub Release notes
        if: steps.latest_tag.outputs.LATEST_TAG != 'v0.0.0'
        run: |
          LATEST_TAG="${{ steps.latest_tag.outputs.LATEST_TAG }}"
          REPO="${{ github.repository }}"
          BUILD_ID="${{ github.run_id }}"
          COMMIT_SHA="${{ github.sha }}"

          # Get existing release notes
          RELEASE_NOTES=$(gh release view "$LATEST_TAG" --repo "$REPO" --json body -q '.body' 2>/dev/null || echo "")
          
          # Get commits since last tag
          PREV_TAG=$(git describe --tags --abbrev=0 HEAD^ 2>/dev/null || echo "")
          if [ -n "$PREV_TAG" ]; then
            COMMITS=$(git log --pretty=format:"- %s (%h)" "$PREV_TAG"..HEAD)
            FILES_CHANGED=$(git diff --name-only "$PREV_TAG"..HEAD | head -20)
          else
            COMMITS=$(git log --pretty=format:"- %s (%h)" -10)
            FILES_CHANGED=$(git diff --name-only HEAD~10..HEAD 2>/dev/null | head -20)
          fi

          NODE_VERSION=$(node -v)
          RELEASE_DATE=$(date +'%Y-%m-%d %H:%M:%S UTC')
          
          # Get package size
          PACKAGE_SIZE=$(npm pack --dry-run 2>&1 | grep "total files" || echo "N/A")

          cat > release_notes.md <<EOF
          $RELEASE_NOTES

          ---

          ## ðŸ“¦ Installation

          \`\`\`bash
          npm install @subrotosaha/datekit
          # or
          yarn add @subrotosaha/datekit
          # or
          pnpm add @subrotosaha/datekit
          \`\`\`

          ## ðŸ”„ Changes in this release

          ### Commits
          $COMMITS

          ### Changed Files
          \`\`\`
          ${FILES_CHANGED}
          \`\`\`

          ## ðŸ”§ Technical Details
          
          | Detail | Value |
          |--------|-------|
          | ðŸ“… Release Date | $RELEASE_DATE |
          | ðŸ“¦ Node.js | $NODE_VERSION |
          | ðŸ”¨ Build ID | [$BUILD_ID](https://github.com/$REPO/actions/runs/$BUILD_ID) |
          | ðŸ“ Commit | \`${COMMIT_SHA:0:7}\` |

          ## ðŸ”— Links
          
          - [ðŸ“– Documentation](https://github.com/$REPO#readme)
          - [ðŸ“¦ NPM Package](https://www.npmjs.com/package/@subrotosaha/datekit)
          - [ðŸ”„ Changelog](https://github.com/$REPO/blob/main/CHANGELOG.md)
          - [ðŸ› Report Issues](https://github.com/$REPO/issues)
          EOF

          gh release edit "$LATEST_TAG" \
            --repo "$REPO" \
            --notes-file release_notes.md
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: âœ… Release complete
        run: |
          echo "ðŸŽ‰ Release complete!"
          echo "ðŸ“¦ Package: @subrotosaha/datekit"
          echo "ðŸ”— NPM: https://www.npmjs.com/package/@subrotosaha/datekit"
